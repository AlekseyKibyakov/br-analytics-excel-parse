
# Br-analytics-parser

### Инструкции по установке:
+ Установка виртуального окружения

        python -m venv .venv
        .venv/bin/Activate.ps1

+ Установка зависимостей из requirements.txt

        pip install -r requirements.txt
***

#### config.py
Файл находится в .gitignore. В нём:
+ DB_LOGIN - словарь с данными для подключения к БД.
+ MAIL_PASSWORD - пароль от почты для внешних приложений.
Как получить - [тут](https://help.mail.ru/mail/security/protection/external).

#### models.py
+ class Message  
Модель таблицы Сообщения, содержащая все соответствующие атрибуты.
+ class Tag  
Модель таблицы Тега, состоящая из идентификатора и названия.
+ class message_tag  
Промежуточная таблица для связи many-to-many у тегов и сообщений.

#### get_excel_file.py
Получение последнего файла отчёта с эл. почты. Связь идёт через mail.ru.  
Понадобится MAIL_PASSWORD из config.py и username (адрес почтового ящика).  
Осуществляется поиск по отправителю <no-reply@br-analytics.ru>.  
Полученный из вложений файл записывается в report.xlsx.

#### parsing_excel.py
+ open_excel()  
Функция открывает report.xlxs с помощью openpyxl.  
Возвращает numpy массив np_sh (получаем его из листа "Упоминания"(sh)), с которым в дальнейшем работают остальные функции.
+ parse_tags(np_sh)  
Функция получает названия тегов, проходя по первой строке таблицы.  
После этого передаёт их на добавление в БД (см. ниже).
+ parse_messages(np_sh)  
Проход в цикле по всем записям в массиве.  
В функции создаётся словарь, в который помещаются все данные о сообщении. Создаётся экземпляр модели Message, куда распаковывается данный словарь.  
Объект модели отправляется в БД. В этой же итерации цикла, проверяются все теги на принадлежность данному сообщению, и также передаются в БД.
+ run()  
Основная функция, которая запускает остальные, а также настраивает логирование.

#### db_interaction.py
Функция отвечает за подключение к базе данных. Работа происходит посредством создания engine и session.  
Все операции с объектами БД проиходят через сессии.  
+ add_tags_to_message(message_id, tags)  
Реализовано добавление тегов к сообщению, вызывается в parsing_excel.py после добавления сообщения в БД.  
+ add_to_db(object)  
Добавляет объект к сессии
+ close_session()  
Закрывает сессию
